---
title: 并行数据库与分布式数据库
comment: true
date: 2021-03-16 19:27:47
tags:
categories:
addrlink:
---

# 并行数据库

**并行数据库系统**，**Parallel Database System**，是在大规模并行处理机（Massive Parallel Processor）和集群并行计算环境的基础上建立的数据库系统。

其实，现在的并行数据库，并不是像Mysql、Oracle这种较传统的关系型数据库，又或者像Redis、MongoDB这种较新的非关系型数据库，它是一种设计思想：将现有的数据库管理技术与并行处理技术结合起来，将以前的串行转变为并行，从而充分发挥出多处理器、多内存、多磁盘的优势。

总的来说，目前的并行数据库技术的研究重点是：数据操作的**时间并行性**和**空间并行性**。

为了实现时间、空间的并行性，需要对以下这3个问题进行相关的研究：**数据分布**、**并行操作算法**、**查询处理优化**。



## 目标

一个并行数据库应该实现如下目标：高性能、高可用性、可扩充性

**高性能：** 

主要指性能比相应大型机系统高得多，并划算得多

例如，将数据库在多个磁盘上分布存储，然后利用多个处理机对磁盘数据进行并行处理，从而解决磁盘I/O瓶颈问题。通过开发查询间并行、查询内并行以及操作内并行，从而大大提高查询效率



**高可用性：**

主要指并行数据库通过数据复制来增强数据库的可用性



**可扩充性：**

主要指并行数据库系统通过增加处理和存储能力，从而平滑地扩展性能的能力





## 并行物理结构

并行数据库的常见并行物理结构有：

1. **共享内存（Share Memory，SM）**

2. **共享磁盘（Share Disk，SD）**

3. **无共享资源（Share Nothing，SN）**



### 共享内存

共享内存的并行结构：

<img src="D:\blog\source\_drafts\并行数据库与分布式数据库\1.png" alt="image-20210316201425404" style="zoom:80%;" />



全部的处理器与磁盘共享一个主存储器，总线连接。

优点：在各个处理器间，有着非常高的通信效率，所以可以很好地实现负载均衡

不足：其规模不得大于64个处理器，不然会出现瓶颈



###  共享磁盘

共享磁盘的并行结构：

<img src="D:\blog\source\_drafts\并行数据库与分布式数据库\2.png" alt="image-20210316201729266" style="zoom:80%;" />



全部处理器共享一个磁盘，互联网进行连接，各个处理器均能对全部磁盘进行访问，各个处理器均有专属自己的主存储器

优点：较好的容错性

不足：速度较慢





### 无共享资源

无共享资源的并行结构：

<img src="D:\blog\source\_drafts\并行数据库与分布式数据库\3.png" alt="image-20210316201806497" style="zoom: 80%;" />



各个处理器间不共享主存储器，不共享磁盘

优点：无共享体系结构，扩展性好，支持诸多处理器工作

不足：在进行数据传输时，会涉及到两端的软件交互，速度相对较慢





三种并行结构比较：

|          | 共享内存 | 共享磁盘 | 无共享资源 |
| -------- | -------- | -------- | ---------- |
| 性能     | 最佳     | 较佳     | 较佳       |
| 可用性   | 低       | 较高     | 高         |
| 可扩充性 | 差       | 较好     | 好         |
| 负载均衡 | 易做到   | 易做到   | 难做到     |
| 实现技术 | 容易     | 较复杂   | 复杂       |
| 成本     | 高       | 较低     | 低         |
| 处理机数 | 数十个   | 数百个   | 数千个     |
| 规模     | 中小系统 | 中小系统 | 大系统     |

我个人感觉，这三种结构的发展方向是：

共享内存---->共享磁盘---->无共享资源

单服务器-------------------->多服务器

其实，到了无共享资源的结构，差不多就是分布式数据库了





## 数据分布

数据分布是将数据划分到多个数据库中，它是实现并行数据库系统的基础

将数据分布到各个处理结点上，一般有**数据分段**和**数据分配**这两个步骤

- 数据分段：将关系划分为若干个数据的子集，其分段方法又分为垂直分段与水平分段；垂直分段是划分关系的属性（将数据表竖着划分），水平分段是划分关系的数据（将数据表的数据划分，横着划分）
- 数据分配：将数据分段所划分出来的数据子集分配到不同的处理结点上



垂直分段与水平分段比较：水平分段能够通过数据子集的并操作还原出最原始的关系，方便负载的均衡分配，并能够增强查询时间内的数据并行性，而且，实现起来也比垂直分段的容易多，因此，一般常用的数据分段常用水平分段的方法。



那么，水平分段该按什么原则来对数据进行划分呢？常见的有轮转法（round-bin）、Hash法、Range法（值域划分法）。

**轮转法（Round-bin）：** 就像派扑克牌那样，按顺序将数据轮流分到各个数据库中

**Hash法：** 设计Hash函数，然后通过Hash函数决定将数据放到哪个数据库中

**Range法（值域划分法）：** 按照某个属性的取值范围将数据文件划分为N段，然后分别存放到N个数据库中



不过不管用什么方法，多多少少都会有一点数据偏斜的现象

数据偏斜：指数据在各个数据库间分配不均

数据偏斜的种类：属性值偏斜 、划分偏斜

解决方法：

1. 设计好的Hash函数，设计好某个属性的取值范围
2. 



## 并行化形式

并行化可以分为**水平并行化（独立并行化，Independent Parallelism）**与**垂直并行化（流水线并行化，Pipelining Parallelism）**

**水平并行化：** 指，相互独立的多个操作，或者一个操作内相互独立的多个子操作，分别由不同的处理机并行执行

**垂直并行化：** 指，存在流水线形式的依赖关系的操作，分别由不同的处理机并行执行

> 若两个操作无相互依赖关系，则称这两个操作相互独立



### 并行粒度

也就是：并行程度

主要有4种并行粒度：

1. **事物间并行性**（不同事务间的并行性）
2. **查询间并行性**（事务内的并行性）
3. **操作间并行性**（同一查询内不同操作间的并行性）
4. **操作内并行性**（同一操作内的并行性）

显然，其并行粒度，1<2<3<4



## 故障处理

任何东西都逃不过故障出错，并行数据库也是如此

既然如此，那该如何处理呢

主要有三种解决方法：数据冗余、资源冗余、恢复机制





## 查询处理优化





## 问题

1. 现在有什么较好的并行数据库系统吗

   答：现在大型的并行数据库使用的都是Shared-Nothing结构，典型的有Teradata，至于小型的如Mysql，目前Mysql在并行的实现尚处于起步阶段，而Mysql8.0引入了比较初级的并行查询，其使用的结构是Share-Memory，与之相似的还有一个数据库系统，PostgreSQL，该数据库支持并行查询，其中包括顺序扫描查询、索引扫描、连接查询。总的来说是，PostgreSQL在并行方面做的比Mysql是好很多的。

2. 介绍一下PostgreSQL的并行查询

   答：PostgreSQL的并行由多个进程的机制完成。每个进程在内部称之为1个worker，这些worker可以动态地创建、销毁。PostgreSQL在SQL语句解析和生成查询计划阶段并没有并行。在执行器（Executor）模块，由多个worker并发执行被分片过的子任务。即使在查询计划被并行执行的环节，一直存在的进程也会充当一个worker来完成并行的子任务，我们可以称之为主进程。同时，根据配置参数指定的worker数，再启动n个worker进程来执行其他子计划。

   PostgreSQL内延续了共享内存的机制，在每个worker初始化时就为每个worker分配共享内存，用于worker各自获取计划数据和缓存中间结果。这些worker间没有复杂的通信机制，而是都由主进程做简单的通信，来启动和执行计划。

3. 并行数据库这么好，实现起来有什么问题吗，现在还有什么难题吗

   答：并行数据库想法是好，充分利用多CPU、多内存、多磁盘的特性，就好像从单人单干变成多人合作，不过我个人觉得没有绝对的好。好的并行数据库，需要处理很多通信机制与消息传递机制的问题，比如数据划分问题，数据偏斜问题，对资源的竞争问题，数据组装问题，还有最基本的ACID问题，而且钱也是一个大问题。所以，并行数据库更适用于大规模的数据分析系统。

4. 并行数据库中并行处理的体系结构有哪些？

   答：并行数据库的处理结构主要有四种：全共享结构，多处理机之间的通信和数据交换通过共享的主存储器直接进行，这种结构又称为对称多处理机。共享磁盘结构，各处理机拥有自己的局部的主存储器，但是共享系统中的磁盘存储器之间和处理器之间的通信可以通过共享磁盘存储器间接实现。无共享结构，处理机之间没有任何共享资源。处理机之间的通信完全靠高速互联网实现。这种结构也被称为大规模并行处理结构的MPP系统。除此之外，还有分层并行结构，它融合了全共享结构和无共享结构各自特点的并行结构。在分层结构中有许多超级节点由高速互联网连接。每个超级节点实际上都是一个全共享结构。这种结构存在两种层次的并行性，因而称为分层并行结构。

5. 比较一下常用的数据分布技术

   答：常用的数据分布技术主要有轮转法、Hash法、值域划分法，通过了解其实现原理，我们可以很容易得知，不同数据分布技术的存取效率是不一样。轮转法，实现起来很简单，它比较适合顺序扫描查询，对点查询和范围查询的处理比较复杂。Hash法则比较适合点查询，速度较快，当然前提是设计一个好的Hash函数。值域划分法则对点查询、范围查询以及顺序扫描查询的支持都比较好，所以适用性比较广，不过，前提是划分好，不然的话就好出现数据偏斜的问题，继而出现执行偏斜的问题。

6. 并行数据库中的数据偏斜问题有哪些

   答：数据偏斜可以分为三种，原始数据偏斜，是由于数据本身的特性造成的数据分段的不均匀；乘积数据偏斜，是指承担并行连接的多个处理机所产生的连接结果严重不均匀的现象；重分布数据偏斜，即使不存在原始数据偏斜，但如果关系的划分属性与连接属性不同，对于某些连接算法就需要将关系在连接属性上进行重新分布，而这重新分布的过程可能会造成数据偏斜，而这种数据偏斜就叫作重分布数据偏斜。

7. 怎么解决数据偏斜和执行偏斜的问题

   答：执行偏斜是因为数据偏斜，所以这两个问题可以合并成一个问题，怎么解决数据偏斜问题，其实这问题解决不了，只能尽量避免，数据偏斜问题是因为Hash法或者值域划分法引起的，所以最基本的方法就是设计较好的Hash函数和值域划分，其次就是使用虚拟技术，将一个大节点划分为许多个小节点，然后将数据划分到这些小节点上

8. 并行数据库是怎么实现并行的

   答：在理论上，并行数据库是通过实现事务间的并行、事务内的并行、操作间的并行和操作内的并行来实现并行的。事务间的并行，指不同事务并行；事务内的并行，指同一事务内的多个不相关的查询进行并行；操作间的并行，指同一查询内的多个操作进行并行；操作内的并行，指将一个操作分解成多个独立的子操作，然后并行。

9. 可以再具体说一下并行数据库与分布式数据库的区别吗

   答：正如刚刚PPT上所讲，并行数据库与分布式数据库主要有三个方面不同，应用目标不同，并行数据库目标是发挥并行计算机的优势，利用各处理器结点并行完成数据库任务，而分布式数据库目标在于实现场地自治和数据的全局透明共享，不需要各节点提供处理性能；实现方式不同，并行数据库为了充分利用各结点处理能力，采用高速网络连接。传输代价相对较低，某些结点空闲，可将负载大的结点的任务通过高速网传给空闲结点处理，而分布式数据库为了满足分布特点，各结点采用局域网或广域网相连，网络带宽较低，结点间通信开销大，因此查询处理时尽量较少结点间的数据传输量；各个节点地位不同，并行数据库各个结点并不平等，只有一个结点与用户接口，负责接受用户请求，输出处理结果，确定执行方案，而其余节点只具有执行操作和彼此通信能力，并行数据库在逻辑上是一个具有一个前台处理机和多个后台处理机结点模型的系统，结点在数据处理中只发挥协同作用，而分布式数据库各结点从逻辑上完全平等，没有主次之分。

10. 并行数据库如何处理服务器故障问题

    答：对于这个问题，并行数据库的处理与普通数据库的处理类似，当主服务器崩了，就让从服务器替代顶上，这过程主要通过数据复制技术来解决。数据复制是将一台主机的数据复制到其他主机上，复制过程中一个服务器充当主服务器，其他服务器充当从服务器，主服务器将更新写入二进制日志文件，并维护文件的一个索引以跟踪日志循环。这些日志可以记录发送到从服务器的更新。当一个从服务器连接主服务器时，它通知主服务器从服务器在日志中读取的最后一次成功更新的位置。从服务器接收从那时起发生的任何更新，然后封锁并等待主服务器通知新的更新。

    

## 常见术语



- **MMP数据库：** Massive Parallel Processing数据库，大型并行处理数据库
- **SSD：** Solid State Disk，固态硬盘
- **SAS接口：** SAS，Serial Attached SCSI，即串行连接SCSI

- **SATA磁盘：** SATA，Serial ATA，串口硬盘

# 分布式数据库







<br/>

<br/>

参考：

[林荣智.并行数据库技术分析与展望[J].信息通信,2016(12):200-201. 垃圾](https://kns.cnki.net/kcms/detail/detail.aspx?dbcode=CJFD&dbname=CJFDLAST2017&filename=HBYD201612095&v=pubitC%25mmd2BPQ8T5RkZTXc1E0scRfn8MZEKUsRh4%25mmd2BslICAKA7OYGBripmyFv%25mmd2FJOpE2zz)

[黄楠.并行数据库数据分布策略研究[J].计算机光盘软件与应用,2012,15(21):145-146. 越看越垃圾](https://kns.cnki.net/kcms/detail/detail.aspx?dbcode=CJFD&dbname=CJFD2012&filename=GPRJ201221085&v=J3RZY%25mmd2Fp21GPfSvStoM9MIE32iYlQYkM4X66bAd9i85WYlQqOUH5hk9fSCtYvGuYm)

