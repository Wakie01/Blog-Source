---
title: MySQL单表数据量过千万的优化方案
comment: true
date: 2020-07-25 23:25:39
tags: 
- Mysql
- 性能优化 
categories: DB Design 
addrlink: 2326
---


## 前言

数据库设计，当面对多表多数据时，确实是一件头疼的事，如果再考虑速度的话，那就更让人头皮发麻了。

因此特意找了一下关于这方面的应对方法，主要有3个方向：

1. 优化现有的数据库
2. 换个更好的数据库
3. 使用大数据技术


后两个我还没接触过，因此主要整理一下第一个。


## Mysql优化

Mysql优化也有几个方面：

1. 优化数据库和表设计
2. 优化SQL语句
3. 分区
4. 分表
5. 分库

每一种都是很有技巧，可惜我一样都不会
![img1](./MySQL单表数据量过千万的优化方案/1.jpg)
所以要学!


### 优化数据库和表设计


**表设计**

- 表字段避免null值出现，null值很难查询优化且占用额外的索引空间，推荐默认数字0代替null

- 字段大小能少就少，能用Int的别用Bigint，能用Smallint的就别用int

- 使用枚举或整数代替字符串类型

- 尽量使用TIMESTAMP而非DATETIME

- 单表不要有太多字段，建议在20以内

- 用整型来存IP

- 使用简单的数据类型，整型比字符处理开销更小，因为字符串的比较更复杂。如，int类型存储时间类型

- 使用合理的字段属性长度，固定长度的表会更快。使用enum、char而不是varchar

- 尽量少用text，非用不可最好分表


**索引**

- 索引并不是越多越好，要根据查询有针对性的创建，考虑在WHERE和ORDER BY命令上涉及的列建立索引，可根据EXPLAIN来查看是否用了索引还是全表扫描

- 应尽量避免在WHERE子句中对字段进行NULL值判断，否则将导致引擎放弃使用索引而进行全表扫描

- 值分布很稀少的字段不适合建索引，例如"性别"这种只有两三个值的字段

- 字符字段只建前缀索引

- 字符字段最好不要做主键

- 不用外键，由程序保证约束

- 尽量不用UNIQUE，由程序保证约束

- 使用多列索引时主意顺序和查询条件保持一致，同时删除不必要的单列索引

- 长度小的列，索引字段越小越好，因为数据库的存储单位是页，一页中能存下的数据越多越好



### 优化SQL语句

- 使用limit对查询结果的记录进行限定

- 避免select *，将需要查找的字段列出来

- 使用连接（join）来代替子查询

- 拆分大的delete或insert语句

- 可通过开启慢查询日志来找出较慢的SQL

- 不做列运算：SELECT id WHERE age + 1 = 10，任何对列的操作都将导致表扫描，它包括数据库教程函数、计算表达式等等，查询时要尽可能将操作移至等号右边

- sql语句尽可能简单：一条sql只能在一个cpu运算；大语句拆小语句，减少锁时间；一条大sql可以堵死整个库

- OR改写成IN：OR的效率是n级别，IN的效率是log(n)级别，in的个数建议控制在200以内

- 不用函数和触发器，在应用程序实现

- 避免%xxx式查询

- 少用JOIN

- 使用同类型进行比较，比如用'123'和'123'比，123和123比

- 尽量避免在WHERE子句中使用!=或<>操作符，否则将引擎放弃使用索引而进行全表扫描

- 对于连续数值，使用BETWEEN不用IN：SELECT id FROM t WHERE num BETWEEN 1 AND 5

- 列表数据不要拿全表，要使用LIMIT来分页，每页数量也不要太大


参考：[MySQL单表数据量过千万，采坑优化记录，完美解决方案](https://www.cnblogs.com/wuer888/p/11793259.html)